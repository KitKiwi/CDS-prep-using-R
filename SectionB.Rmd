---
title: "B. ENROLLMENT AND PERSISTENCE"
author: "California State University, East Bay"
date: "generated on `r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document: default
  word_document: default
  pdf_document: default
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhf{}
- \chead{Common Data Set 2020-2021}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r include=FALSE}
# Install and load packages

if(!require(tidyverse)) install.packages("tidyverse",repos = "http://cran.us.r-project.org")

library(tidyverse)
library(knitr)

# Create a reference for the directory where the ERS submission files are stored.

ERSdir <- file.path("G:\\My Drive\\AAprojects\\CDSusingR\\2020-2021\\ERS")

```

## B1.	Institutional Enrollment - Men and Women

```{r echo=FALSE}

# Read in ERS state and self files.

ERSS <- read.fwf(file.path(ERSdir, "ERSS\\ERS.PROD.T2020405"), 
                 width = c(-24,1,-1,1,-26,1,1,1,-10,1,-44,3,3,3,-92,1,3,-13,1,-14,9,-56,2),
                 col.names=c('SexCode','CitizenshipCode','EnrollmentStatus','StudentLevelCode',
                             'DegreeObjectiveCode','StudentStandingCode','LDunits','UDunits','GradUnits',
                             'MatriculationType','PreUnits','IPEDSEthnicity','EmployeeID','GenderIdentityCode'),
                 colClasses=c('character','character','numeric','numeric',
                              'numeric','character','numeric','numeric','numeric',
                              'character','numeric','numeric','character','numeric'))
sERS <- read.fwf(file.path(ERSdir, "sERSS\\SER.PROD.T2020405"), 
                 width = c(-24,1,-1,1,-26,1,1,1,-10,1,-44,3,3,3,-92,1,-16,1,-5,9,-13,3,-46,2),
                 col.names=c('SexCode','CitizenshipCode','EnrollmentStatus','StudentLevelCode',
                             'DegreeObjectiveCode','StudentStandingCode','LDunits','UDunits','GradUnits',
                             'MatriculationType','IPEDSEthnicity','EmployeeID','PreUnits','GenderIdentityCode'),
                 colClasses=c('character','character','numeric','numeric',
                              'numeric','character','numeric','numeric','numeric',
                              'character','numeric','character','numeric','numeric'))
ERS <- dplyr::bind_rows("R" = ERSS, "E" = sERS, .id = "FileType")
rm(ERSS,sERS)

# All units need to be added to determine full time part time status.

ERS <- mutate(ERS, Units = (PreUnits+LDunits+UDunits+GradUnits)/10)
ERS <- 
  ERS %>%
    group_by(EmployeeID) %>% 
    mutate(TotalUnits=sum(Units))

# Check for students enrolled as state and self.

DupeTable <- data.frame(table(ERS$EmployeeID))
#DupeTable[DupeTable$Freq > 1,]  

Check <- ERS[ERS$EmployeeID %in% DupeTable$Var1[DupeTable$Freq > 1],14:17]
#Check[order(Check$EmployeeID),]

#Select records based on Matriculation Type. 

colnames(DupeTable) <- c("EmployeeID","N")
ERS <- merge(ERS, DupeTable, by="EmployeeID")

Singles <- subset(ERS, N==1)
Doubles <- subset(ERS,(N==2 & MatriculationType==FileType))
rm(ERS)

ERS <- rbind(Singles,Doubles)
rm(DupeTable, Check, Singles, Doubles)

## N in ERS Sex Code needs to be redistributed to either W or M using Gender Identity Code or last digit of ID number.

LastDigID <- strtoi(substr(ERS$EmployeeID,9,9))
ERS <- cbind(ERS,LastDigID)
Gender <- recode(ERS$SexCode, "F"="W", "M"="M")
ERS <- cbind(ERS,Gender)
rm(LastDigID,Gender)
CDSsex <- with(ERS, ifelse(SexCode=="N", 
                            ifelse(GenderIdentityCode>=14,ifelse(LastDigID%%2==0,"W","M"),
                                   ifelse(GenderIdentityCode %in% c(10,12),"M","W")) ,Gender))

## Recode ethnicity to match the order, then isolate non residents using Citizenship Code.

Ethnicity <- recode(ERS$IPEDSEthnicity,"7"=2,"2"=3,"1"=4,"3"=5,"4"=6,"5"=7,"6"=8,"8"=9)
ERS <-cbind(ERS,Ethnicity)
rm(Ethnicity)
CDSEthnicity <- with(ERS, ifelse(CitizenshipCode %in% c("F","J","O","N"),1,Ethnicity ))

## Here degree type is defined using Enrollment Status and Student Level Code, and Career based on Level and Degree Objective Code.

CDSdegreeType <- with(ERS, ifelse(EnrollmentStatus == 5, ifelse(StudentLevelCode < 5,1,5), 
                                   ifelse(EnrollmentStatus==6, ifelse(StudentLevelCode<5,4,7),
                                          ifelse(StudentLevelCode==1,2,ifelse(StudentLevelCode==5,6,3)) )))
CDScareer <- with(ERS, ifelse(StudentLevelCode < 5 | (DegreeObjectiveCode < 5 & DegreeObjectiveCode > 0), 1, 2))
ERS <- cbind(ERS,CDScareer)
rm(CDScareer)

FTPT <- with(ERS, ifelse((CDScareer == 1 & TotalUnits >= 12)|(CDScareer ==2 & TotalUnits >= 9), 'FT', 'PT'))
B1 <- ftable(CDSdegreeType, FTPT, CDSsex, row.vars = "CDSdegreeType")
rm(FTPT, CDSsex)

sec1 <- B1[1:3,1:4]
sec1wt <- rbind(sec1,c(colSums(sec1)))
sec2 <- rbind(c(colSums(sec1)),B1[4,1:4])
sec2wt <- rbind(sec2,c(colSums(sec2)))
sec3 <- B1[5:7,1:4]
sec3wt <- rbind(sec3,c(colSums(sec3,na.rm = TRUE)))
sec4 <- colSums(B1)
revB1 <- rbind(sec1,sec2wt,sec3wt,sec4)
rm(sec1, sec1wt, sec2, sec2wt, sec3, sec3wt, sec4, B1)

options(scipen = 999)
totalUG <- sum(revB1[6,1:4])
totalG <- sum(revB1[10,1:4])
grandTotal <- totalUG + totalG
rownames(revB1) <- c("Degree-seeking, first-time freshman","Degree-seeking, Other first-year","Degree-seeking, Other",
                     "Total degree-seeking","All other undergraduates","Total Undergraduates",
                     "Degree-seeking, first-time grad","Degree-seeking, Other grad","All other grad","Total grad","Total all students")
colnames(revB1) <- c("FT Men","FT Women","PT Men","PT Women")
kable(revB1)
```

Total all undergraduates: `r totalUG`   
Total all graduate: `r totalG`   
GRAND TOTAL ALL STUDENTS: `r grandTotal`    

## B2.	Enrollment by Racial/Ethnic Category

```{r echo=FALSE}

# Clean up the data no longer needed.
rm(revB1, totalUG, totalG, grandTotal)

# Use the fields defined above.

B2table <- table(CDSEthnicity, CDSdegreeType) 
rm(CDSEthnicity, CDSdegreeType)

B2sec2 <- rowSums(B2table[,1:3])
B2sec3 <- rowSums(B2table[,1:4])
B2cols <- cbind(B2table[1:9,1],B2sec2,B2sec3)
B2total <- colSums(B2cols)
B2 <- rbind(B2cols,B2total)
rm(B2sec2, B2sec3, B2cols, B2total, B2table)

rownames(B2) <- c("Nonresident aliens","Hispanic/Latino","Black or African American, non-Hispanic","White, non-Hispanic",
                  "American Indian or Alaska Native, non-Hispanic","Asian, non-Hispanic","Native Hawaiian or other Pacific Islander, non-Hispanic",
                  "Two or more races, non-Hispanic","Race and/or ethnicity unknown","TOTAL")
colnames(B2) <- c("Degree-Seeking First-Time First Year","Degree-Seeking Undergraduates","Total Undergraduates")

kable(B2)

```

# Persistence
## B3.	Number of degrees awarded by your institution from July 1, 2019, to June 30, 2020

```{r echo=FALSE}

rm(B2)

# Read in ERSD files.

ERSDsummer <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2020305"), 
                 width = c(-53,1),
                 col.names=c('DegreeLevelCode'),
                 colClasses=c('character'))
ERSDfall_spring <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2021205"), 
                     width = c(-53,1),
                     col.names=c('DegreeLevelCode'),
                     colClasses=c('character'))
ERSD <- rbind(ERSDsummer,ERSDfall_spring)
rm(ERSDsummer, ERSDfall_spring)


Degree <- recode(ERSD$DegreeLevelCode,"2"="BA","3"="BA","4"="BA","5"="MA","6"="MA","7"="MA","8"="Doc")
B3table <- table(Degree)
rm(Degree)

ba <- B3table[1]
ma <- B3table[3]
dr <- B3table[2]
rm(B3table, ERSD)

```
   
Certificate/diploma: 0     
Associate degrees: 0     
Bachelor's degrees: `r ba`     
Postbachelor's certificates: 0     
Master's degrees: `r ma`     
Post-master's certificates: 0     
Doctoral degrees - research/scholarship: 0     
Doctoral degrees - professional practice: 0     
Doctoral degrees - other:  `r dr`  

#NOTE1: CSUEB does not offer certificates or associate degrees.   
#NOTE2: CSUEB offers only one doctoral degree (EDD) and it is considered to be other doctoral degree.   

# B4-B21 Graduation Rates
## For Bachlor's Programs using Fall 2014 Cohort

```{r echo=FALSE}


rm(ba, ma, dr)

# I will omit the breakdown by Pell grant and Stafford loans. Only the totals are done here. 

# Chancellor's Office did not include self-support students for 2014 cohort, so I use the state side only.
ERSS <- read.fwf(file.path(ERSdir, "ERSS\\ERS.PROD.T2014405"), 
                 width = c(-53,1,1,1,-10,1,-44,3,3,3,-93,3,-28,9),
                 col.names=c('EnrollmentStatus','StudentLevelCode','DegreeObjectiveCode','StudentStandingCode',
                             'LDunits','UDunits','GradUnits','PreUnits','EmployeeID'),
                 colClasses=c('numeric','numeric','numeric','character',
                              'numeric','numeric','numeric','numeric','character'))
ERSS <- mutate(ERSS, TotalUnits = (PreUnits+LDunits+UDunits+GradUnits)/10)

# Select first time full time undergraduate students.
FTFT <- subset(ERSS,EnrollmentStatus==5 & StudentLevelCode < 5 & TotalUnits >= 12, select = EmployeeID)
rm(ERSS)

# 4,5,6 year graduation records = fall 2014 through summer 2020.

ERSD2152 <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2015205"), 
                 width = c(-9,5,-39,1,-50,9),
                 col.names=c('YearTerm','DegreeLevelCode','EmployeeID'),
                 colClasses=c('numeric','character','character'))
ERSD2153 <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2015305"), 
                 width = c(-9,5,-39,1,-50,9),
                 col.names=c('YearTerm','DegreeLevelCode','EmployeeID'),
                 colClasses=c('numeric','character','character'))
ERSD2162 <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2016205"), 
                 width = c(-9,5,-39,1,-50,9),
                 col.names=c('YearTerm','DegreeLevelCode','EmployeeID'),
                 colClasses=c('numeric','character','character'))
ERSD2163 <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2016305"), 
                 width = c(-9,5,-39,1,-50,9),
                 col.names=c('YearTerm','DegreeLevelCode','EmployeeID'),
                 colClasses=c('numeric','character','character'))
ERSD2172 <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2017205"), 
                 width = c(-9,5,-39,1,-50,9),
                 col.names=c('YearTerm','DegreeLevelCode','EmployeeID'),
                 colClasses=c('numeric','character','character'))
ERSD2173 <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2017305"), 
                 width = c(-9,5,-39,1,-50,9),
                 col.names=c('YearTerm','DegreeLevelCode','EmployeeID'),
                 colClasses=c('numeric','character','character'))
ERSD2182 <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2018205"), 
                 width = c(-9,5,-39,1,-50,9),
                 col.names=c('YearTerm','DegreeLevelCode','EmployeeID'),
                 colClasses=c('numeric','character','character'))
ERSD2183 <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2018305"), 
                 width = c(-9,5,-39,1,-50,9),
                 col.names=c('YearTerm','DegreeLevelCode','EmployeeID'),
                 colClasses=c('numeric','character','character'))
ERSD2192 <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2019205"), 
                 width = c(-9,5,-39,1,-50,9),
                 col.names=c('YearTerm','DegreeLevelCode','EmployeeID'),
                 colClasses=c('numeric','character','character'))
ERSD2193 <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2019305"), 
                 width = c(-9,5,-39,1,-50,9),
                 col.names=c('YearTerm','DegreeLevelCode','EmployeeID'),
                 colClasses=c('numeric','character','character'))
ERSD2202 <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2020205"), 
                 width = c(-9,5,-39,1,-50,9),
                 col.names=c('YearTerm','DegreeLevelCode','EmployeeID'),
                 colClasses=c('numeric','character','character'))
ERSD2203 <- read.fwf(file.path(ERSdir, "ERSD\\ERD.PROD.T2020305"), 
                 width = c(-9,5,-39,1,-50,9),
                 col.names=c('YearTerm','DegreeLevelCode','EmployeeID'),
                 colClasses=c('numeric','character','character'))
ERSDtotal <- rbind(ERSD2152,ERSD2153,ERSD2162,ERSD2163,ERSD2172,ERSD2173,ERSD2182,ERSD2183,ERSD2192,ERSD2193,ERSD2202,ERSD2203) 
rm(ERSD2152,ERSD2153,ERSD2162,ERSD2163,ERSD2172,ERSD2173,ERSD2182,ERSD2183,ERSD2192,ERSD2193,ERSD2202,ERSD2203)

# select only UG degrees in case a higher degree is earned during the same time frame.
UGdegrees <- subset(ERSDtotal,DegreeLevelCode < 5)

# match cohort with UG degree records.
Graduated <- merge(FTFT,UGdegrees,by="EmployeeID")
rm(UGdegrees, ERSDtotal)

# check for multiple degrees
#Graduated[duplicated(Graduated$EmployeeID)]

FourOrless <- with(Graduated, ifelse(YearTerm<=20183,1,0))
FourToFive <- with(Graduated, ifelse(YearTerm<=20193,ifelse(YearTerm<=20183,0,1),0))
FiveToSix <- with(Graduated, ifelse(YearTerm<=20203,ifelse(YearTerm<=20193,0,1),0))
SixOrLess <- with(Graduated, ifelse(YearTerm<=20203,1,0))
rm(Graduated)

CohortN <- nrow(FTFT)
FourOrLessN <- sum(FourOrless)
FourToFiveN <- sum(FourToFive)
FiveToSixN <- sum(FiveToSix)
SixOrLessN <- sum(SixOrLess)
SixYrGR <- round((SixOrLessN/CohortN)*100,digits = 0)
rm(FourOrless, FourToFive, FiveToSix, SixOrLess, FTFT)

```

A. Initial 2014 Cohort of first-time full-time bachelor's degree-seeking undergraduate students: `r CohortN`     
B. Of the initial 2014 cohort, how many did not persist: 0   
C. Final 2014 cohort, after adjusting for allowable exclusions: `r CohortN`   
D. Completed in four years or less: `r FourOrLessN`   
E. Completed in more than four years but in five years or less: `r FourToFiveN`   
F. Completed in more than five years but in six years or less: `r FiveToSixN`   
G. Total graduating within six years: `r SixOrLessN`   
H. Six year graduation rate: `r SixYrGR`   

# B22 Retention Rates
## One Year Retention Rate of Fall 2019 full-time bachelor's degree-seeking undergraduate students

```{r echo=FALSE}

rm(CohortN, FourOrLessN, FourToFiveN, FiveToSixN, SixOrLessN, SixYrGR)

# Read in fall 2019 enrollment files.  Here I include both state and self.

ERSS_ret <- read.fwf(file.path(ERSdir, "ERSS\\ERS.PROD.T2019405"), 
                 width = c(-24,1,-1,1,-26,1,1,1,-10,1,-44,3,3,3,-92,1,3,-13,1,-14,9,-56,2),
                 col.names=c('SexCode','CitizenshipCode','EnrollmentStatus','StudentLevelCode',
                             'DegreeObjectiveCode','StudentStandingCode','LDunits','UDunits','GradUnits',
                             'MatriculationType','PreUnits','IPEDSEthnicity','EmployeeID','GenderIdentityCode'),
                 colClasses=c('character','character','numeric','numeric',
                              'numeric','character','numeric','numeric','numeric',
                              'character','numeric','numeric','character','numeric'))
sERS_ret <- read.fwf(file.path(ERSdir, "sERSS\\SER.PROD.T2019405"), 
                 width = c(-24,1,-1,1,-26,1,1,1,-10,1,-44,3,3,3,-92,1,-16,1,-5,9,-13,3,-46,2),
                 col.names=c('SexCode','CitizenshipCode','EnrollmentStatus','StudentLevelCode',
                             'DegreeObjectiveCode','StudentStandingCode','LDunits','UDunits','GradUnits',
                             'MatriculationType','IPEDSEthnicity','EmployeeID','PreUnits','GenderIdentityCode'),
                 colClasses=c('character','character','numeric','numeric',
                              'numeric','character','numeric','numeric','numeric',
                              'character','numeric','character','numeric','numeric'))
ERS_ret <- dplyr::bind_rows("R" = ERSS_ret, "E" = sERS_ret, .id = "FileType")
rm(ERSS_ret, sERS_ret)

# add all the units together.
ERS_ret <- mutate(ERS_ret, Units = (PreUnits+LDunits+UDunits+GradUnits)/10)
ERS_ret <- 
  ERS_ret %>%
    group_by(EmployeeID) %>% 
    mutate(TotalUnits=sum(Units))

# Check for students enrolled as state and self.

DupeTable <- data.frame(table(ERS_ret$EmployeeID))
#DupeTable[DupeTable$Freq > 1,]  

Check <- ERS_ret[ERS_ret$EmployeeID %in% DupeTable$Var1[DupeTable$Freq > 1],12:15]
#Check[order(Check$EmployeeID),]

#Select records based on Matriculation Type to unduplicate. 

colnames(DupeTable) <- c("EmployeeID","N")
ERS_ret <- merge(ERS_ret, DupeTable, by="EmployeeID")

Singles <- subset(ERS_ret, N==1)
Doubles <- subset(ERS_ret,(N==2 & MatriculationType==FileType))
rm(ERS_ret)

ERS_ret <- rbind(Singles,Doubles)
rm(DupeTable, Check, Singles, Doubles)

FTFT_ret <- subset(ERS_ret,EnrollmentStatus==5 & StudentLevelCode < 5 & TotalUnits >= 12, select= EmployeeID)

# match Cohort19 with fall 20 enrollment records.

RetainedList <- merge(FTFT_ret,ERS,by="EmployeeID")
Retained <- sprintf("%1.0f%%" ,(nrow(RetainedList)/nrow(FTFT_ret))*100)
rm(RetainedList, FTFT_ret, ERS_ret, ERS)

```

B22: Percent of fall 2019 cohort enrolled in fall 2020:`r Retained`
